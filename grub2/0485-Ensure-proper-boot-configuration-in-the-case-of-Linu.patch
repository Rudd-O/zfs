From bd579cf59c25399b59d6c98dc6b1d4630f95c099 Mon Sep 17 00:00:00 2001
From: Fedora Ninjas <grub2-owner@fedoraproject.org>
Date: Thu, 5 Jun 2014 23:59:22 -0700
Subject: [PATCH] Ensure proper boot configuration in the case of Linux on ZFS

---
 util/grub.d/10_linux.in     | 8 +++++++-
 util/grub.d/20_linux_xen.in | 8 +++++++-
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/util/grub.d/10_linux.in b/util/grub.d/10_linux.in
index 5ed7695..17743d7 100644
--- a/util/grub.d/10_linux.in
+++ b/util/grub.d/10_linux.in
@@ -67,7 +67,13 @@ case x"$GRUBFS" in
     xzfs)
 	rpool=`${grub_probe} --device ${GRUB_DEVICE} --target=fs_label 2>/dev/null || true`
 	bootfs="`make_system_path_relative_to_its_root / | sed -e "s,@$,,"`"
-	LINUX_ROOT_DEVICE="ZFS=${rpool}${bootfs}"
+	fs=$(cat /etc/fstab | while read fs mntpnt type ; do
+		[ "$mntpnt" != "/" ] && continue
+		[ "$fs" == "rootfs" ] && continue
+		echo "$fs"
+		break
+	done)
+	LINUX_ROOT_DEVICE="ZFS=${fs}"
 	;;
 esac
 
diff --git a/util/grub.d/20_linux_xen.in b/util/grub.d/20_linux_xen.in
index 4372c0c..5844a48 100644
--- a/util/grub.d/20_linux_xen.in
+++ b/util/grub.d/20_linux_xen.in
@@ -75,7 +75,13 @@ case x"$GRUBFS" in
     xzfs)
 	rpool=`${grub_probe} --device ${GRUB_DEVICE} --target=fs_label 2>/dev/null || true`
 	bootfs="`make_system_path_relative_to_its_root / | sed -e "s,@$,,"`"
-	LINUX_ROOT_DEVICE="ZFS=${rpool}${bootfs}"
+	fs=$(cat /etc/fstab | while read fs mntpnt type ; do
+		[ "$mntpnt" != "/" ] && continue
+		[ "$fs" == "rootfs" ] && continue
+		echo "$fs"
+		break
+	done)
+	LINUX_ROOT_DEVICE="ZFS=${fs}"
 	;;
 esac
 
-- 
1.9.3

